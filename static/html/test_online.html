<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <title>在线考试</title>
    <link rel="shortcut icon" type="image/icon" href="/static/img/logo_black.png">

    <!-- Bootstrap JQuery依赖 -->
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css"/>

    <script src="/static/js/jquery-3.5.1.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- 侧边栏跟随组件 -->
    <script src="/static/js/accessory.js"></script>
    <link rel="stylesheet" href="/static/css/test_online.css"/>
    <link rel="stylesheet" href="/static/fontawesome/css/all.min.css">
</head>
<body>
<div id="pane">
    <!-- 顶部固定标题栏 -->
    <div class="container-fluid shadow header">
        <div class="container">
            <div class="row">
                <div class="col-2 exam-title">{{ testName }}</div>
                <div class="col-3 exam-info">
                    <span class="exam-limit" v-if="timeLeft < 0">考试不限时间&nbsp;&nbsp;</span>
                    <span v-else>
                        <span class="exam-limit">考试剩余时间&nbsp;&nbsp;</span>
                        <span class="exam-time time-alert">{{ timeLeft | formatTime }}</span>
                    </span>
                </div>
                <button type="button" class="btn btn-success col-1 offset-11" @click="submitPaper">我要交卷</button>
            </div>
        </div>
    </div>

    <!-- 试卷内容部分 -->
    <div id="main" class="container">
        <div class="row">
            <!-- 试卷主体 -->
            <div class="col-9">
                <div>
                    <div class="question" v-for="(item, index) in questions"
                         :id="'qs_' + index" @dblclick="handleMark(index + 1)"
                         :class="{marked: marked.includes(index + 1)}">
                        <div class="topic_type">
                            <em></em>
                            <h2>{{ item.type | typeToStr }} <span>（本题{{ item.qpscore }}分）</span></h2>
                        </div>
                        <div class="question_content">
                            <div class="question_stem">
                                <span>{{ index + 1 }}. </span>{{ item.stem }}
                            </div>
                            <div class="question_select">
                                <div class="select_item" v-for="(choice, cidx) in item.choices">
                                    <input class="num" type="button" name="question_1"
                                           :value="toLetter(cidx)" @click="handleAnswer(item, $event)"
                                           :class="{
                                               chosen: answers[item.questionID]
                                                        && (answers[item.questionID].choice.includes(toLetter(cidx)))
                                           }">
                                    <span>{{ choice }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 答题卡 -->
            <div class="col-3" style="padding: 0;">
                <div id="sidebar" class="answer-card">
                    <h3 style="text-align: center; margin-top: 16px;">答题卡</h3>
                    <hr/>
                    <div class="card-item" v-if="questionStat.select.length">
                        <h6>单项选择题</h6>
                        <div class="list">
                            <a :href="'#qs_' + item.idx" class="num" v-for="item in questionStat.select"
                               :class="{
                                    chosen: answers[item.questionID] && (answers[item.questionID].choice.length > 0),
                                    marked: marked.includes(item.idx)
                               }">
                                {{ item.idx }}
                            </a>
                        </div>
                    </div>
                    <div class="card-item" v-if="questionStat.multi.length">
                        <h6>多项选择题</h6>
                        <div class="list">
                            <a :href="'#qs_' + item.idx" class="num" v-for="item in questionStat.multi"
                               :class="{
                                    chosen: answers[item.questionID] && (answers[item.questionID].choice.length > 0),
                                    marked: marked.includes(item.idx)
                               }">
                                {{ item.idx }}
                            </a>
                        </div>
                    </div>
                    <div class="card-item" v-if="questionStat.fill.length">
                        <h6>填空题</h6>
                        <div class="list">
                            <a :href="'#qs_' + item.idx" class="num" v-for="item in questionStat.fill"
                               :class="{
                                    chosen: answers[item.questionID] && (answers[item.questionID].choice.length > 0),
                                    marked: marked.includes(item.idx)
                               }">
                                {{ item.idx }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="decoration-line">
        <span class="end">试卷到达结尾</span>
    </div>
</div>

<script src="/static/js/jquery-3.5.1.min.js"></script>
<script src="/static/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/sweetalert2/sweetalert2.all.min.js"></script>
<script src="/static/js/vue.js"></script>
<script src="/static/js/axios.js"></script>
<script>
    function parseSearchParam() {
        let res = {};
        let params = location.search.substring(1).split('&');
        params.forEach(ele => {
            // 拆分成键值对，放入res对象中
            let pair = ele.split('=');
            res[pair[0]] = pair[1];
        });

        return res;
    }

    // 设置Toast用于提示考试时间节点
    const Toast = Swal.mixin({
        toast: true,
        position: 'bottom-start',
        showConfirmButton: false,
        close: true,
        showCloseButton: true,
    });

    let pane = new Vue({
        el: '#pane',
        data: {
            testName: '',
            timeLeft: 0,
            timer: -1,
            questions: [],
            answers: {}, // answers用于缓存已作答的题目答案,
            marked: []  // 保存标记了的题号
        },
        methods: {
            submitPaper() {
                // 提示正在提交试卷
                Swal.fire({
                    title: '提示',
                    html: '正在提交试卷',
                    didOpen: () => {
                        Swal.showLoading()
                    }
                });
                axios.get('/exam/grading?tno=' + this.params['tno']).then(resp => {
                    console.log(resp.data);
                    if (resp.data.code === 200) {
                        // 提示试卷提交成功
                        Swal.fire({
                            icon: 'success',
                            title: '试卷提交成功',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(res => {
                            location.href = '/exam/detail?tno=' + this.params['tno'];
                        });
                    }
                });
            },
            handleMark(idx) {
                // 调用一次标记指定题目，再调用取消标记
                let i = this.marked.indexOf(idx);
                if (i < 0)
                    this.marked.push(idx);
                else
                    this.marked.splice(i, 1);
                console.log(this.marked);
            },
            handleAnswer(item, event) {
                let targetAnswer = this.answers[item.questionID];
                // 如果缓存不存在，需要临时创建缓存
                if (!targetAnswer) {
                    targetAnswer = this.answers[item.questionID] = {
                        questionID: item.questionID,
                        choice: []
                    };
                }

                // 单项选择题只允许缓存一个答案
                // 但为了和其他题型的一致性，仍使用数组缓存其答案
                if (item.type === 'select') {
                    if (targetAnswer.choice.includes(event.target.value))
                        return;  // 不对重复点击相同选项做响应，以提高性能
                    targetAnswer.choice.pop();
                    targetAnswer.choice.push(event.target.value);
                } else if (item.type === 'multi') {
                    let idx = targetAnswer.choice.indexOf(event.target.value);
                    // 对于多选题点击两次选项将取消选择
                    if (idx < 0) targetAnswer.choice.push(event.target.value);
                    else targetAnswer.choice.splice(idx, 1);
                }

                // 更新提交时间戳
                targetAnswer.submitTime = Date.now();
                // 由于多层嵌套的数组更新并不引起重绘，因此强制要求刷新
                this.$forceUpdate();

                // 向服务器提交当前题目作答情况
                $.ajax({
                    url: '/exam/questions',
                    method: 'POST',
                    data: {
                        examID: this.params['tno'],
                        result: JSON.stringify([targetAnswer])
                    },
                    success(resp) {
                        // TODO: 需要考虑提交失败情况，进行重试操作
                        console.log(resp.code);
                    }
                });
            },
            toLetter(idx) {
                return String.fromCharCode('A'.charCodeAt(0) + idx);
            },
            calibrateTime() {
                if (this.timer > 0)  // 清除之前的计时器
                    clearInterval(this.timer);
                axios.get('/exam/time?examID=' + this.params['tno']).then(resp => {
                    let data = resp.data;
                    if (data.code === 200) {
                        this.questions = data.questions;
                        this.testName = data.tname;
                        this.timeLeft = data.timeLeft.toFixed(0);

                        // 限时的考试需要倒计时
                        if (this.timeLeft > 0) {
                            this.timer = setInterval(() => {
                                this.timeLeft--;
                                if (this.timeLeft <= 0) {
                                    // 考试结束
                                    this.submitPaper();
                                } else if (this.timeLeft < 3 * 60) {
                                    // 进行考试结束前3分钟提醒
                                    Toast.fire({
                                        icon: 'warning',
                                        title: '离考试结束还有3分钟'
                                    });
                                } else if (this.timeLeft < 15 * 60) {
                                    // 进行考试结束前15分钟提醒
                                    Toast.fire({
                                        icon: 'warning',
                                        title: '离考试结束还有15分钟'
                                    });
                                }
                            }, 1000);
                        }
                    }
                });
            },
            loadQuestions() {
                axios.get('/exam/questions?examID=' + this.params['tno']).then(resp => {
                    let data = resp.data;
                    if (data.code === 200) {
                        this.questions = data.questions;

                        // 如果服务器有缓存，则加载缓存
                        for (let item of this.questions) {
                            this.answers[item.questionID] = {
                                questionID: item.questionID,
                                choice: item.cache ? item.cache.choice : []
                            };
                        }
                    }
                });
            }
        },
        computed: {
            questionStat() {
                let res = {
                    select: [],
                    multi: [],
                    fill: []
                };
                // 防止报错，貌似计算属性先于普通属性创建
                if (!this.questions)
                    return res;

                // 分别记录选择题、多选题和填空题对应的题号
                for (let i = 0; i < this.questions.length; i++) {
                    let tmp = {idx: i + 1, questionID: this.questions[i].questionID};
                    switch (this.questions[i].type) {
                        case 'select':
                            res.select.push(tmp);
                            break;
                        case 'multi':
                            res.multi.push(tmp);
                            break;
                        case 'fill':
                            res.fill.push(tmp);
                            break;
                    }
                }
                return res;
            }
        },
        filters: {
            typeToStr(type) {
                let res = '';
                switch (type) {
                    case 'select':
                        res = '单项选择题';
                        break;
                    case 'multi':
                        res = '多项选择题';
                        break;
                    case 'fill':
                        res = '填空题';
                        break;
                }

                return res;
            },
            formatTime(seconds) {
                let n = 2;
                let hours = (Array(n).join('0') + String((seconds / 3600).toFixed(0))).slice(-n);
                seconds %= 3600;
                let minutes = (Array(n).join('0') + String((seconds / 60).toFixed(0))).slice(-n);
                seconds %= 60;
                seconds = (Array(n).join('0') + String((seconds).toFixed(0))).slice(-n);


                return `${hours}:${minutes}:${seconds}`;
            }
        },
        mounted() {
            this.params = parseSearchParam();
            this.loadQuestions();

            this.calibrateTime();
            // 对于限时的考试，每5分钟向服务器进行一次时间校正
            if (this.timeLeft)
                setInterval(() => this.calibrateTime(), 300);
        }
    });
</script>
</body>
</html>